@model IEnumerable<web3_kaypic.Models.TMessage>
@{
    Layout = null;
    ViewData["Title"] = "Circle";
    var currentUserEmail = User.Identity?.Name ?? User.FindFirst(System.Security.Claims.ClaimTypes.Email)?.Value ?? "Anonymous";
}
<link rel="stylesheet" href="~/css/actualite.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
    .post-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
    }

    .delete-post-btn {
        color: #999;
        cursor: pointer;
        font-size: 16px;
        transition: color 0.3s;
    }

        .delete-post-btn:hover {
            color: #e74c3c;
        }

    .post-footer {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        align-items: center;
    }

    .post-action {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        color: #666;
        transition: color 0.3s;
    }

        .post-action:hover {
            color: #e91e63;
        }

        .post-action.liked {
            color: #e91e63;
        }

        .post-action i {
            font-size: 18px;
        }

        .post-action span {
            font-size: 14px;
        }

    .comments-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .comment {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
        padding: 8px;
        background: #f9f9f9;
        border-radius: 8px;
        position: relative;
    }

        .comment:hover .delete-comment-btn {
            opacity: 1;
        }

    .delete-comment-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        color: #999;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.3s;
        opacity: 0;
    }

        .delete-comment-btn:hover {
            color: #e74c3c;
        }

    .comment-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        background: #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        overflow: hidden;
    }

        .comment-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

    .comment-content {
        flex: 1;
    }

    .comment-username {
        font-weight: bold;
        font-size: 14px;
        margin-bottom: 2px;
    }

    .comment-text {
        font-size: 14px;
        color: #333;
    }

    .comment-input-box {
        display: none;
        margin-top: 10px;
        gap: 10px;
    }

        .comment-input-box.active {
            display: flex;
        }

        .comment-input-box input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            outline: none;
        }

        .comment-input-box button {
            padding: 8px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
        }

            .comment-input-box button:hover {
                background: #0056b3;
            }
    /* Emoji picker */
    .emoji-picker {
        position: absolute;
        bottom: 60px;
        left: 10px;
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        display: none;
        max-width: 320px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 1000;
    }

        .emoji-picker.active {
            display: block;
        }

    .emoji-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 5px;
        max-height: 200px;
        overflow-y: auto;
    }

    .emoji-item {
        font-size: 24px;
        cursor: pointer;
        padding: 5px;
        text-align: center;
        border-radius: 4px;
        transition: background 0.2s;
    }

        .emoji-item:hover {
            background: #f0f0f0;
        }
    /* Image preview */
    .image-preview {
        margin-top: 10px;
        position: relative;
        display: none;
    }

        .image-preview.active {
            display: block;
        }

        .image-preview img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .image-preview .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    /* Post image */
    .post-image {
        margin-top: 10px;
        max-width: 100%;
        border-radius: 8px;
    }

        .post-image img {
            max-width: 100%;
            border-radius: 8px;
            cursor: pointer;
        }
    /* Icons interactifs */
    .icons i {
        cursor: pointer;
        transition: color 0.3s;
    }

        .icons i:hover {
            color: #007bff;
        }
    /* User avatar - photos de profil */
    .user-avatar {
        width: 50px; /* taille du conteneur */
        height: 50px;
        border-radius: 50%; /* cercle */
        overflow: hidden; /* masque le débordement */
        display: flex;
        align-items: center;
        justify-content: center;
        background: #f8f9fa; /* fond gris clair */
        border: 2px solid #9e3b42; /* couleur Kaypic */
    }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover; /* recadre l’image sans déformation */
        }
</style>

<div class="feed-container">
    @Html.Partial("Header")
    <main class="feed">
        <!-- Post box -->
        <div class="post-box" style="position: relative;">
            <div class="user-avatar">
                <i class="fa fa-user" aria-hidden="true"></i>
            </div>
            <div class="post-input">
                <textarea id="messageInput" placeholder="Something to say?" required></textarea>

                <!-- Image preview -->
                <div id="imagePreview" class="image-preview">
                    <img id="previewImg" src="" alt="Preview">
                    <button class="remove-image" id="removeImageBtn">×</button>
                </div>

                <div class="post-actions">
                    <div class="icons">
                        <i class="fa-regular fa-face-smile" id="emojiBtn" title="Add emoji"></i>
                        <i class="fa-regular fa-image" id="imageBtn" title="Add image"></i>
                        <i class="fa-solid fa-paperclip"></i>
                    </div>
                    <button id="sendButton" class="btn-post">Post</button>
                </div>

                <!-- Hidden file input -->
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>

            <!-- Emoji picker -->
            <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>
        </div>

        <!-- Container pour les posts -->
        <div id="postsContainer">
            @foreach (var message in Model)
            {
                <div class="post" data-post-id="@message.msg_id">
                    <div class="user-avatar">
                        @if (!string.IsNullOrEmpty(message.msg_user_profile_image_url))
                        {
                            <img src="@message.msg_user_profile_image_url" alt="Avatar">
                        }
                        else
                        {
                            <i class="fa fa-user" aria-hidden="true"></i>
                        }
                    </div>
                    <div class="post-content">
                        <div class="post-header">
                            <div>
                                <span class="username">@message.msg_username</span>
                                <span class="time">@GetTimeAgo(message.msg_created_at)</span>
                            </div>
                            @if (message.msg_username == currentUserEmail)
                            {
                                <i class="fa-solid fa-trash delete-post-btn" data-post-id="@message.msg_id" title="Delete post"></i>
                            }
                        </div>
                        <p>@message.msg_content</p>

                        @if (!string.IsNullOrEmpty(message.msg_image_url))
                        {
                            <div class="post-image">
                                <img src="@message.msg_image_url" alt="Post image">
                            </div>
                        }

                        <div class="post-footer">
                            <div class="post-action comment-btn" data-post-id="@message.msg_id">
                                <i class="fa-regular fa-comment"></i>
                                <span class="comment-count">@message.Comments.Count</span>
                            </div>
                            <div class="post-action like-btn" data-post-id="@message.msg_id">
                                <i class="fa-regular fa-heart"></i>
                                <span class="like-count">@message.msg_likes_count</span>
                            </div>
                        </div>

                        <!-- Zone de commentaires -->
                        <div class="comments-section" id="comments-@message.msg_id">
                            @foreach (var comment in message.Comments.OrderBy(c => c.comment_created_at))
                            {
                                <div class="comment" data-comment-id="@comment.comment_id">
                                    <div class="comment-avatar">
                                        @if (!string.IsNullOrEmpty(comment.comment_user_profile_image_url))
                                        {
                                            <img src="@comment.comment_user_profile_image_url" alt="Avatar">
                                        }
                                        else
                                        {
                                            <i class="fa fa-user"></i>
                                        }
                                    </div>
                                    <div class="comment-content">
                                        <div class="comment-username">@comment.comment_username</div>
                                        <div class="comment-text">@comment.comment_content</div>
                                    </div>
                                    @if (comment.comment_username == currentUserEmail)
                                    {
                                        <i class="fa-solid fa-trash delete-comment-btn"
                                           data-comment-id="@comment.comment_id"
                                           data-post-id="@message.msg_id"
                                           title="Delete comment"></i>
                                    }
                                </div>
                            }
                        </div>

                        <!-- Input pour nouveau commentaire -->
                        <div class="comment-input-box" id="comment-input-@message.msg_id">
                            <input type="text" placeholder="Write a comment..." class="comment-text-input">
                            <button class="submit-comment-btn" data-post-id="@message.msg_id">Send</button>
                        </div>
                    </div>
                </div>
            }
        </div>
    </main>
</div>

<!-- SignalR Script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
<script>
    const currentUserEmail = '@currentUserEmail';
    let uploadedImageUrl = null;

    // Liste d'emojis populaires
    const emojis = ['😀','😃','😄','😁','😆','😅','🤣','😂','🙂','🙃','😉','😊','😇','🥰','😍','🤩','😘','😗','😚','😙','🥲','😋','😛','😜','🤪','😝','🤑','🤗','🤭','🤫','🤔','🤐','🤨','😐','😑','😶','😏','😒','🙄','😬','🤥','😌','😔','😪','🤤','😴','😷','🤒','🤕','🤢','🤮','🤧','🥵','🥶','😵','🤯','🤠','🥳','🥸','😎','🤓','🧐','😕','😟','🙁','☹️','😮','😯','😲','😳','🥺','😦','😧','😨','😰','😥','😢','😭','😱','😖','😣','😞','😓','😩','😫','🥱','😤','😡','😠','🤬','😈','👿','💀','☠️','💩','🤡','👹','👺','👻','👽','👾','🤖','😺','😸','😹','😻','😼','😽','🙀','😿','😾'];

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/messageHub")
        .withAutomaticReconnect()
        .build();

    function getTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);

        if (diffMins < 1) return "Just now";
        if (diffMins < 60) return `${diffMins}m`;

        const diffHours = Math.floor(diffMins / 60);
        if (diffHours < 24) return `${diffHours}h`;

        const diffDays = Math.floor(diffHours / 24);
        return `${diffDays}d`;
    }

    // Initialiser le picker d'emoji
    const emojiGrid = document.getElementById('emojiGrid');
    emojis.forEach(emoji => {
        const span = document.createElement('span');
        span.className = 'emoji-item';
        span.textContent = emoji;
        span.onclick = () => insertEmoji(emoji);
        emojiGrid.appendChild(span);
    });

    // Toggle emoji picker
    document.getElementById('emojiBtn').addEventListener('click', function() {
        document.getElementById('emojiPicker').classList.toggle('active');
    });

    // Fermer emoji picker si clic ailleurs
    document.addEventListener('click', function(e) {
        const picker = document.getElementById('emojiPicker');
        const btn = document.getElementById('emojiBtn');
        if (!picker.contains(e.target) && e.target !== btn) {
            picker.classList.remove('active');
        }
    });

    // Insérer emoji dans textarea
    function insertEmoji(emoji) {
        const textarea = document.getElementById('messageInput');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        textarea.value = text.substring(0, start) + emoji + text.substring(end);
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = start + emoji.length;
    }

    // Gestion de l'upload d'image
    document.getElementById('imageBtn').addEventListener('click', function() {
        document.getElementById('imageInput').click();
    });

    document.getElementById('imageInput').addEventListener('change', async function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('image', file);

        try {
            const response = await fetch('/Upload/UploadImage', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const data = await response.json();
                uploadedImageUrl = data.imageUrl;

                document.getElementById('previewImg').src = uploadedImageUrl;
                document.getElementById('imagePreview').classList.add('active');
            } else {
                const error = await response.json();
                alert(error.error || 'Upload failed');
            }
        } catch (err) {
            console.error('Upload error:', err);
            alert('Failed to upload image');
        }
    });

    // Supprimer l'image
    document.getElementById('removeImageBtn').addEventListener('click', function() {
        uploadedImageUrl = null;
        document.getElementById('imagePreview').classList.remove('active');
        document.getElementById('imageInput').value = '';
    });

    // Recevoir les nouveaux posts - AVEC photo de profil
    connection.on("ReceiveCirclePost", function (userName, content, createdAt, postId, imageUrl, profileImageUrl) {
        const postsContainer = document.getElementById("postsContainer");

        const imageHtml = imageUrl ? `<div class="post-image"><img src="${imageUrl}" alt="Post image"></div>` : '';

        // Avatar avec photo de profil ou icône par défaut
        const avatarHtml = profileImageUrl
            ? `<img src="${profileImageUrl}" alt="Avatar">`
            : `<i class="fa fa-user" aria-hidden="true"></i>`;

        const deleteBtn = userName === currentUserEmail ?
            `<i class="fa-solid fa-trash delete-post-btn" data-post-id="${postId}" title="Delete post"></i>` : '';

        const postHtml = `
            <div class="post" data-post-id="${postId}">
                <div class="user-avatar">
                    ${avatarHtml}
                </div>
                <div class="post-content">
                    <div class="post-header">
                        <div>
                            <span class="username">${userName}</span>
                            <span class="time">${getTimeAgo(createdAt)}</span>
                        </div>
                        ${deleteBtn}
                    </div>
                    <p>${content}</p>
                    ${imageHtml}
                    <div class="post-footer">
                        <div class="post-action comment-btn" data-post-id="${postId}">
                            <i class="fa-regular fa-comment"></i>
                            <span class="comment-count">0</span>
                        </div>
                        <div class="post-action like-btn" data-post-id="${postId}">
                            <i class="fa-regular fa-heart"></i>
                            <span class="like-count">0</span>
                        </div>
                    </div>
                    <div class="comments-section" id="comments-${postId}"></div>
                    <div class="comment-input-box" id="comment-input-${postId}">
                        <input type="text" placeholder="Write a comment..." class="comment-text-input">
                        <button class="submit-comment-btn" data-post-id="${postId}">Send</button>
                    </div>
                </div>
            </div>
        `;

        postsContainer.insertAdjacentHTML('afterbegin', postHtml);
    });

    // Recevoir les likes
    connection.on("ReceiveLike", function (messageId, newLikesCount) {
        const post = document.querySelector(`[data-post-id="${messageId}"]`);
        if (post) {
            const likeCount = post.querySelector('.like-count');
            if (likeCount) {
                likeCount.textContent = newLikesCount;
            }
        }
    });

    // Recevoir les commentaires - AVEC photo de profil
    connection.on("ReceiveComment", function (messageId, commentId, userName, content, createdAt, profileImageUrl) {
        const commentsSection = document.getElementById(`comments-${messageId}`);
        if (commentsSection) {
            const deleteBtn = userName === currentUserEmail ?
                `<i class="fa-solid fa-trash delete-comment-btn" data-comment-id="${commentId}" data-post-id="${messageId}" title="Delete comment"></i>` : '';

            // Avatar avec photo de profil ou icône par défaut
            const avatarHtml = profileImageUrl
                ? `<img src="${profileImageUrl}" alt="Avatar">`
                : `<i class="fa fa-user"></i>`;

            const commentHtml = `
                <div class="comment" data-comment-id="${commentId}">
                    <div class="comment-avatar">
                        ${avatarHtml}
                    </div>
                    <div class="comment-content">
                        <div class="comment-username">${userName}</div>
                        <div class="comment-text">${content}</div>
                    </div>
                    ${deleteBtn}
                </div>
            `;
            commentsSection.insertAdjacentHTML('beforeend', commentHtml);

            const post = document.querySelector(`[data-post-id="${messageId}"]`);
            const commentCount = post.querySelector('.comment-count');
            if (commentCount) {
                commentCount.textContent = parseInt(commentCount.textContent) + 1;
            }
        }
    });

    // Recevoir la suppression d'un commentaire
    connection.on("ReceiveDeleteComment", function (messageId, commentId) {
        const comment = document.querySelector(`[data-comment-id="${commentId}"]`);
        if (comment) {
            comment.style.transition = 'opacity 0.3s';
            comment.style.opacity = '0';
            setTimeout(() => {
                comment.remove();
                const post = document.querySelector(`[data-post-id="${messageId}"]`);
                const commentCount = post.querySelector('.comment-count');
                if (commentCount) {
                    commentCount.textContent = Math.max(0, parseInt(commentCount.textContent) - 1);
                }
            }, 300);
        }
    });

    // Recevoir la suppression d'un post
    connection.on("ReceiveDeletePost", function (messageId) {
        const post = document.querySelector(`[data-post-id="${messageId}"]`);
        if (post) {
            post.style.transition = 'opacity 0.3s';
            post.style.opacity = '0';
            setTimeout(() => post.remove(), 300);
        }
    });

    connection.start().then(function () {
        console.log("Connected to SignalR");
    }).catch(function (err) {
        console.error("SignalR connection error: " + err.toString());
    });

    // Publier un message
    document.getElementById("sendButton").addEventListener("click", function (event) {
        event.preventDefault();
        const messageInput = document.getElementById("messageInput");
        const message = messageInput.value.trim();

        if (message === "" && !uploadedImageUrl) {
            alert("Please enter a message or add an image");
            return;
        }

        connection.invoke("SendCirclePost", currentUserEmail, message, uploadedImageUrl)
            .then(function () {
                messageInput.value = "";
                uploadedImageUrl = null;
                document.getElementById('imagePreview').classList.remove('active');
                document.getElementById('imageInput').value = '';
            })
            .catch(function (err) {
                console.error("Error sending message: " + err.toString());
            });
    });

    // Gestion de la suppression de commentaire
    document.addEventListener("click", function(e) {
        if (e.target.closest('.delete-comment-btn')) {
            const deleteBtn = e.target.closest('.delete-comment-btn');
            const commentId = parseInt(deleteBtn.dataset.commentId);

            if (confirm('Are you sure you want to delete this comment?')) {
                connection.invoke("DeleteComment", commentId, currentUserEmail)
                    .catch(function (err) {
                        console.error("Error deleting comment: " + err.toString());
                        alert("Failed to delete comment");
                    });
            }
        }
    });

    // Gestion de la suppression de post
    document.addEventListener("click", function(e) {
        if (e.target.closest('.delete-post-btn')) {
            const deleteBtn = e.target.closest('.delete-post-btn');
            const postId = parseInt(deleteBtn.dataset.postId);

            if (confirm('Are you sure you want to delete this post?')) {
                connection.invoke("DeleteCirclePost", postId, currentUserEmail)
                    .catch(function (err) {
                        console.error("Error deleting post: " + err.toString());
                        alert("Failed to delete post");
                    });
            }
        }
    });

    // Gestion des likes
    document.addEventListener("click", function(e) {
        if (e.target.closest('.like-btn')) {
            const likeBtn = e.target.closest('.like-btn');
            const postId = parseInt(likeBtn.dataset.postId);

            connection.invoke("LikeCirclePost", postId)
                .catch(function (err) {
                    console.error("Error liking post: " + err.toString());
                });
        }
    });

    // Gestion des commentaires - Afficher/masquer input
    document.addEventListener("click", function(e) {
        if (e.target.closest('.comment-btn')) {
            const commentBtn = e.target.closest('.comment-btn');
            const postId = commentBtn.dataset.postId;
            const commentInput = document.getElementById(`comment-input-${postId}`);

            if (commentInput) {
                commentInput.classList.toggle('active');
                if (commentInput.classList.contains('active')) {
                    commentInput.querySelector('input').focus();
                }
            }
        }
    });

    // Envoyer un commentaire
    document.addEventListener("click", function(e) {
        if (e.target.closest('.submit-comment-btn')) {
            const btn = e.target.closest('.submit-comment-btn');
            const postId = parseInt(btn.dataset.postId);
            const commentInput = document.getElementById(`comment-input-${postId}`);
            const input = commentInput.querySelector('input');
            const content = input.value.trim();

            if (content === "") {
                alert("Please enter a comment");
                return;
            }

            connection.invoke("CommentCirclePost", postId, currentUserEmail, content)
                .then(function () {
                    input.value = "";
                    commentInput.classList.remove('active');
                })
                .catch(function (err) {
                    console.error("Error commenting: " + err.toString());
                });
        }
    });

    // Enter pour envoyer
    document.getElementById("messageInput").addEventListener("keypress", function (event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault();
            document.getElementById("sendButton").click();
        }
    });
</script>

@functions {
    string GetTimeAgo(DateTime date)
    {
        var ts = DateTime.Now - date;
        if (ts.TotalMinutes < 1) return "Just now";
        if (ts.TotalMinutes < 60) return $"{(int)ts.TotalMinutes}m";
        if (ts.TotalHours < 24) return $"{(int)ts.TotalHours}h";
        return $"{(int)ts.TotalDays}d";
    }
}
